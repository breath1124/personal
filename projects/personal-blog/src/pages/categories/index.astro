---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { toUrlSlug } from "../../utils/slug";
import { getCategories } from "../../utils/taxonomy";

const base = import.meta.env.BASE_URL;
const posts = await getCollection("blog", ({ data }) => !data.draft);

const categoryCounts = new Map<string, number>();
for (const post of posts) {
  for (const rawCategory of getCategories(post.data)) {
    const category = rawCategory.trim();
    if (!category) continue;
    categoryCounts.set(category, (categoryCounts.get(category) ?? 0) + 1);
  }
}

const categories = [...categoryCounts.entries()].sort(
  (a, b) => b[1] - a[1] || a[0].localeCompare(b[0], "zh-CN")
);
---

<BaseLayout title="分类">
  <h1>分类</h1>
  <ul class="chip-list">
    {
      categories.map(([category, count]) => (
        <li>
          <a class="chip" href={`${base}categories/${toUrlSlug(category)}/`}>
            {category} <span class="chip-count">({count})</span>
          </a>
        </li>
      ))
    }
  </ul>
</BaseLayout>

