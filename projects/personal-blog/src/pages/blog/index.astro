---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { formatDate } from "../../utils/date";
import { toUrlSlug } from "../../utils/slug";
import { getCategories } from "../../utils/taxonomy";

const base = import.meta.env.BASE_URL;
const posts = (await getCollection("blog", ({ data }) => !data.draft)).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);
---

<BaseLayout title="博客">
  <h1>博客</h1>
  <ul class="post-list" style="margin-top: 1rem">
    {
      posts.map((post) => {
        const categories = getCategories(post.data);
        const tags = (post.data.tags ?? []).map((t) => t.trim()).filter(Boolean);

        return (
          <li class="post-item">
            <h3>
              <a href={`${base}blog/${post.slug}/`}>{post.data.title}</a>
            </h3>
            <div class="meta">
              <time datetime={post.data.pubDate.toISOString()}>
                {formatDate(post.data.pubDate)}
              </time>
            </div>
            <p>{post.data.description}</p>
            {(categories.length > 0 || tags.length > 0) && (
              <div class="taxonomy taxonomy--compact">
                {categories.map((category) => (
                  <a
                    class="chip"
                    href={`${base}categories/${toUrlSlug(category)}/`}
                  >
                    {category}
                  </a>
                ))}
                {tags.map((tag) => (
                  <a class="chip" href={`${base}tags/${toUrlSlug(tag)}/`}>
                    #{tag}
                  </a>
                ))}
              </div>
            )}
          </li>
        );
      })
    }
  </ul>
</BaseLayout>
